<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:f="jakarta.faces.core"
    xmlns:ui="jakarta.faces.facelets">

<ui:composition template="/templates/template.xhtml">

    <ui:define name="content">

        <article>
            <header>
                <h2>#{msg['chat.title']}</h2>
            </header>

            <section class="chat-container">
                <!-- Chat messages area -->
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages will be added here via JavaScript -->
                </div>

                <!-- Message input form with AJAX -->
                <h:form id="chatForm" class="chat-form">
                    <div class="chat-input-container">
                        <!-- Recipient selector -->
                        <div class="recipient-selector">
                            <h:outputLabel for="recipient" value="#{msg['chat.sendTo']}: " />
                            <h:selectOneMenu id="recipient" value="#{chatBean.selectedRecipient}"
                                styleClass="recipient-dropdown">
                                <f:selectItem itemValue="" itemLabel="#{msg['chat.allUsers']}" />
                                <f:selectItems value="#{chatBean.allUsers}" var="user" itemValue="#{user.login}"
                                    itemLabel="#{user.login}" />
                            </h:selectOneMenu>
                        </div>

                        <!-- Message input and send button -->
                        <div class="message-input-row">
                            <h:inputText id="messageInput" value="#{chatBean.messageContent}" styleClass="message-input"
                                placeholder="#{msg['chat.placeholder']}"
                                onkeypress="if(event.keyCode==13){document.getElementById('chatForm:sendBtn').click();return false;}" />

                            <h:commandButton id="sendBtn" value="#{msg['chat.send']}" action="#{chatBean.sendMessage}"
                                styleClass="send-button">
                                <f:ajax execute="@form" render="messageInput recipient" onevent="onMessageSent" />
                            </h:commandButton>
                        </div>
                    </div>
                </h:form>

                <!-- Connected users panel -->
                <div class="connected-users">
                    <h4>#{msg['chat.connectedUsers']}</h4>
                    <ul id="userList">
                        <!-- Will be updated via WebSocket -->
                    </ul>
                </div>
            </section>
        </article>

        <style>
            .chat-container {
                display: grid;
                grid-template-columns: 1fr 200px;
                grid-template-rows: 1fr auto;
                gap: 15px;
                height: 500px;
            }

            .chat-messages {
                grid-column: 1;
                grid-row: 1;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                overflow-y: auto;
                background: #f9f9f9;
            }

            .chat-form {
                grid-column: 1;
                grid-row: 2;
            }

            .connected-users {
                grid-column: 2;
                grid-row: 1 / 3;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                background: #f5f5f5;
            }

            .connected-users h4 {
                margin: 0 0 10px 0;
                color: #333;
            }

            .connected-users ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .connected-users li {
                padding: 5px 10px;
                margin: 3px 0;
                background: #fff;
                border-radius: 4px;
                display: flex;
                align-items: center;
            }

            .connected-users li::before {
                content: "‚óè";
                color: #4CAF50;
                margin-right: 8px;
            }

            .chat-input-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .recipient-selector {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .recipient-dropdown {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                min-width: 150px;
            }

            .message-input-row {
                display: flex;
                gap: 10px;
            }

            .message-input {
                flex: 1;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .send-button {
                padding: 12px 24px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            .send-button:hover {
                background: #0056b3;
            }

            .message {
                margin: 10px 0;
                padding: 10px 15px;
                border-radius: 8px;
                max-width: 80%;
            }

            .message.sent {
                background: #007bff;
                color: white;
                margin-left: auto;
            }

            .message.received {
                background: #e9ecef;
                color: #333;
            }

            .message.private {
                border-left: 3px solid #ffc107;
            }

            .message.system {
                background: #f8f9fa;
                color: #6c757d;
                text-align: center;
                font-style: italic;
                max-width: 100%;
            }

            .message-header {
                font-size: 12px;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .message-content {
                word-wrap: break-word;
            }

            .message-time {
                font-size: 10px;
                opacity: 0.7;
                margin-top: 5px;
                text-align: right;
            }

            .private-indicator {
                font-size: 11px;
                color: #ffc107;
            }
        </style>

        <script type="text/javascript">
            //<![CDATA[
            var websocket;
            var currentUsername = '#{chatBean.currentUsername}';
            var reconnectAttempts = 0;
            var maxReconnectAttempts = 5;

            // Initialize WebSocket connection when page loads
            document.addEventListener('DOMContentLoaded', function () {
                connectWebSocket();
            });

            function connectWebSocket() {
                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                var wsUrl = protocol + '//' + window.location.host + '/chat/' + currentUsername;

                console.log('Connecting to WebSocket:', wsUrl);

                websocket = new WebSocket(wsUrl);

                websocket.onopen = function (event) {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    addSystemMessage('Connected to chat');
                };

                websocket.onmessage = function (event) {
                    console.log('Received:', event.data);
                    var message = JSON.parse(event.data);
                    handleMessage(message);
                };

                websocket.onclose = function (event) {
                    console.log('WebSocket closed');
                    addSystemMessage('Disconnected from chat');

                    // Try to reconnect
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(connectWebSocket, 3000);
                    }
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                };
            }

            function handleMessage(message) {
                if (message.type === 'system') {
                    addSystemMessage(message.content);
                    updateUserList();
                } else if (message.type === 'chat') {
                    addChatMessage(message);
                }
            }

            function addChatMessage(message) {
                var chatDiv = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');

                var isSent = message.sender === currentUsername;
                var isPrivate = !message.broadcast;

                messageDiv.className = 'message ' + (isSent ? 'sent' : 'received') + (isPrivate ? ' private' : '');

                var header = '';
                if (!isSent) {
                    header = '<div class="message-header">' + escapeHtml(message.sender);
                    if (isPrivate) {
                        header += ' <span class="private-indicator">(private)</span>';
                    }
                    header += '</div>';
                } else if (isPrivate) {
                    header = '<div class="message-header">To: ' + escapeHtml(message.recipient) + ' <span class="private-indicator">(private)</span></div>';
                }

                messageDiv.innerHTML = header +
                    '<div class="message-content">' + escapeHtml(message.content) + '</div>' +
                    '<div class="message-time">' + message.timestamp + '</div>';

                chatDiv.appendChild(messageDiv);
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }

            function addSystemMessage(text) {
                var chatDiv = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = '<div class="message-content">' + escapeHtml(text) + '</div>';
                chatDiv.appendChild(messageDiv);
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }

            function updateUserList() {
                // User list is updated via system messages
                // In a real app, we'd fetch the list from server
            }

            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Called after AJAX message send completes
            function onMessageSent(data) {
                if (data.status === 'success') {
                    // Clear the input field
                    var input = document.getElementById('chatForm:messageInput');
                    if (input) {
                        input.value = '';
                        input.focus();
                    }
                }
            }
            //]]>
        </script>

    </ui:define>

</ui:composition>

</html>